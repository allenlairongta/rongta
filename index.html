<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国际电商仓库存管理系统 V1.3-CUS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* 原有样式保持不变 */
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .summary-card {
            color: white;
        }
        .summary-order {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }
        .summary-production {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
        }
        .summary-storage {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        .summary-shipment {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .table-responsive {
            max-height: 400px;
            overflow: auto;
        }
        .table-responsive table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .table-responsive thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #0d6efd;
        }
        .editable {
            cursor: pointer;
        }
        .editable:hover {
            background-color: #f8f9fa;
        }
        .warning-text {
            color: #dc3545;
            font-weight: bold;
        }
        .system-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 15px;
            min-height: 80px;
        }
        .permission-badge {
            font-size: 0.7em;
            margin-left: 5px;
        }
        .readonly-field {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .export-import-buttons {
            margin-bottom: 15px;
        }
        .export-import-buttons .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .user-info-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-sort-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .search-sort-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
        }
        .sort-select {
            width: auto;
            min-width: 150px;
        }
        .inactive-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 9999;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 9998;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .max-quantity-help {
            font-size: 0.875em;
            color: #6c757d;
            margin-top: 5px;
        }
        .table-total-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- 加载中遮罩 -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <span class="ms-2">数据加载中...</span>
    </div>

    <!-- 登录界面 -->
    <div id="login-page" class="container">
        <div class="login-container">
            <h2 class="text-center mb-4">国际电商仓库存管理系统</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">用户名</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">密码</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">登录</button>
            </form>
        </div>
    </div>

    <!-- 主系统界面 -->
    <div id="main-system" style="display: none;">
        <div class="container-fluid py-4">
            <!-- 用户信息栏 -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="user-info d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">国际电商仓库存管理系统</h4>
                            <small>欢迎, <span id="current-user">用户</span> 
                                <span class="permission-badge badge bg-light text-dark" id="user-role">角色</span>
                            </small>
                        </div>
                        <div class="user-info-buttons">
                            <button class="btn btn-light btn-sm" onclick="showUserManagement()" id="user-management-btn" style="display: none;">
                                用户管理
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="logout()">
                                退出登录
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 导出导入按钮（仅管理员可见） -->
            <div class="row mb-4" id="export-import-section" style="display: none;">
                <div class="col-12">
                    <div class="export-import-buttons">
                        <button class="btn btn-success" onclick="exportAllData()">
                            <i class="bi bi-download"></i> 导出所有数据到Excel
                        </button>
                        <button class="btn btn-warning" onclick="showImportModal()">
                            <i class="bi bi-upload"></i> 从Excel导入数据
                        </button>
                    </div>
                </div>
            </div>

            <!-- 库存概览 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card summary-card summary-order">
                        <div class="card-body text-center">
                            <h5 class="card-title">已下单未生产数量</h5>
                            <h2 id="total-order">0</h2>
                            <div id="order-by-product" class="mt-2 small"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card summary-card summary-production">
                        <div class="card-body text-center">
                            <h5 class="card-title">已生产未入库数量</h5>
                            <h2 id="total-production">0</h2>
                            <div id="production-by-product" class="mt-2 small"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card summary-card summary-storage">
                        <div class="card-body text-center">
                            <h5 class="card-title">已入库未出库数量</h5>
                            <h2 id="total-storage">0</h2>
                            <div id="storage-by-product" class="mt-2 small"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card summary-card summary-shipment">
                        <div class="card-body text-center">
                            <h5 class="card-title">总出库数量</h5>
                            <h2 id="total-shipment">0</h2>
                            <div id="shipment-by-product" class="mt-2 small"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 功能导航 -->
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab">订单管理</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="production-tab" data-bs-toggle="tab" data-bs-target="#production" type="button" role="tab">生产管理</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="storage-tab" data-bs-toggle="tab" data-bs-target="#storage" type="button" role="tab">入库管理</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="shipment-tab" data-bs-toggle="tab" data-bs-target="#shipment" type="button" role="tab">出库管理</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">库存统计</button>
                </li>
            </ul>
            
            <!-- 内容区域 -->
            <div class="tab-content" id="myTabContent">
                <!-- 订单管理 -->
                <div class="tab-pane fade show active" id="order" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">订单管理</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal" id="add-order-btn">新增订单</button>
                        </div>
                        <div class="card-body">
                            <!-- 搜索和排序区域 -->
                            <div class="search-sort-container">
                                <div class="search-sort-row">
                                    <input type="text" class="form-control search-input" id="order-search" placeholder="搜索订单编号、产品名称、客户名称...">
                                    <select class="form-select sort-select" id="order-sort">
                                        <option value="id-asc">订单编号 (升序)</option>
                                        <option value="id-desc">订单编号 (降序)</option>
                                        <option value="product-asc">产品名称 (升序)</option>
                                        <option value="product-desc">产品名称 (降序)</option>
                                        <option value="quantity-asc">下单数量 (升序)</option>
                                        <option value="quantity-desc">下单数量 (降序)</option>
                                        <option value="date-asc">下单日期 (升序)</option>
                                        <option value="date-desc">下单日期 (降序)</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" onclick="resetOrderSearch()">
                                        <i class="bi bi-arrow-clockwise"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>订单编号</th>
                                            <th>产品名称</th>
                                            <th>下单数量</th>
                                            <th>已生产数量</th>
                                            <th>未生产数量</th>
                                            <th>下单日期</th>
                                            <th>客户名称</th>
                                            <th>备注</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="order-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 生产管理 -->
                <div class="tab-pane fade" id="production" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">生产管理</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductionModal" id="add-production-btn">新增生产记录</button>
                        </div>
                        <div class="card-body">
                            <!-- 搜索和排序区域 -->
                            <div class="search-sort-container">
                                <div class="search-sort-row">
                                    <input type="text" class="form-control search-input" id="production-search" placeholder="搜索生产批次、订单编号、产品名称...">
                                    <select class="form-select sort-select" id="production-sort">
                                        <option value="id-asc">生产批次 (升序)</option>
                                        <option value="id-desc">生产批次 (降序)</option>
                                        <option value="orderId-asc">订单编号 (升序)</option>
                                        <option value="orderId-desc">订单编号 (降序)</option>
                                        <option value="product-asc">产品名称 (升序)</option>
                                        <option value="product-desc">产品名称 (降序)</option>
                                        <option value="quantity-asc">生产数量 (升序)</option>
                                        <option value="quantity-desc">生产数量 (降序)</option>
                                        <option value="date-asc">生产日期 (升序)</option>
                                        <option value="date-desc">生产日期 (降序)</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" onclick="resetProductionSearch()">
                                        <i class="bi bi-arrow-clockwise"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>生产批次</th>
                                            <th>订单编号</th>
                                            <th>产品名称</th>
                                            <th>下单数量</th>
                                            <th>生产数量</th>
                                            <th>已入库数量</th>
                                            <th>未入库数量</th>
                                            <th>生产日期</th>
                                            <th>负责人</th>
                                            <th>备注</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="production-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 入库管理 -->
                <div class="tab-pane fade" id="storage" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">入库管理</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStorageModal" id="add-storage-btn">新增入库记录</button>
                        </div>
                        <div class="card-body">
                            <!-- 搜索和排序区域 -->
                            <div class="search-sort-container">
                                <div class="search-sort-row">
                                    <input type="text" class="form-control search-input" id="storage-search" placeholder="搜索入库单号、生产批次、产品名称...">
                                    <select class="form-select sort-select" id="storage-sort">
                                        <option value="id-asc">入库单号 (升序)</option>
                                        <option value="id-desc">入库单号 (降序)</option>
                                        <option value="productionId-asc">生产批次 (升序)</option>
                                        <option value="productionId-desc">生产批次 (降序)</option>
                                        <option value="product-asc">产品名称 (升序)</option>
                                        <option value="product-desc">产品名称 (降序)</option>
                                        <option value="quantity-asc">入库数量 (升序)</option>
                                        <option value="quantity-desc">入库数量 (降序)</option>
                                        <option value="date-asc">入库日期 (升序)</option>
                                        <option value="date-desc">入库日期 (降序)</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" onclick="resetStorageSearch()">
                                        <i class="bi bi-arrow-clockwise"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>入库单号</th>
                                            <th>生产批次</th>
                                            <th>订单编号</th>
                                            <th>产品名称</th>
                                            <th>生产数量</th>
                                            <th>入库数量</th>
                                            <th>已出库数量</th>
                                            <th>未出库数量</th>
                                            <th>入库日期</th>
                                            <th>负责人</th>
                                            <th>备注</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="storage-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 出库管理 -->
                <div class="tab-pane fade" id="shipment" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">出库管理</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addShipmentModal" id="add-shipment-btn">新增出库记录</button>
                        </div>
                        <div class="card-body">
                            <!-- 搜索和排序区域 -->
                            <div class="search-sort-container">
                                <div class="search-sort-row">
                                    <input type="text" class="form-control search-input" id="shipment-search" placeholder="搜索出库单号、入库单号、产品名称...">
                                    <select class="form-select sort-select" id="shipment-sort">
                                        <option value="id-asc">出库单号 (升序)</option>
                                        <option value="id-desc">出库单号 (降序)</option>
                                        <option value="storageId-asc">入库单号 (升序)</option>
                                        <option value="storageId-desc">入库单号 (降序)</option>
                                        <option value="product-asc">产品名称 (升序)</option>
                                        <option value="product-desc">产品名称 (降序)</option>
                                        <option value="quantity-asc">出库数量 (升序)</option>
                                        <option value="quantity-desc">出库数量 (降序)</option>
                                        <option value="date-asc">出库日期 (升序)</option>
                                        <option value="date-desc">出库日期 (降序)</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" onclick="resetShipmentSearch()">
                                        <i class="bi bi-arrow-clockwise"></i> 重置
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>出库单号</th>
                                            <th>入库单号</th>
                                            <th>生产批次</th>
                                            <th>订单编号</th>
                                            <th>产品名称</th>
                                            <th>入库数量</th>
                                            <th>出库数量</th>
                                            <th>出库日期</th>
                                            <th>客户名称</th>
                                            <th>备注</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shipment-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 库存统计 -->
                <div class="tab-pane fade" id="inventory" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">库存统计</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>产品名称</th>
                                            <th>总下单数量</th>
                                            <th>总生产数量</th>
                                            <th>总入库数量</th>
                                            <th>总出库数量</th>
                                            <th>已下单未生产</th>
                                            <th>已生产未入库</th>
                                            <th>已入库未出库</th>
                                            <th>当前库存</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventory-table-body"></tbody>
                                </table>
                            </div>
                            <div class="mt-4">
                                <canvas id="inventoryChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增订单模态框 -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增订单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="order-form">
                        <div class="mb-3">
                            <label for="order-id" class="form-label">订单编号</label>
                            <input type="text" class="form-control" id="order-id">
                            <div class="form-text">可自定义订单编号，如不填写将自动生成</div>
                        </div>
                        <div class="mb-3">
                            <label for="order-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="order-product" required>
                        </div>
                        <div class="mb-3">
                            <label for="order-quantity" class="form-label">下单数量</label>
                            <input type="number" class="form-control" id="order-quantity" required>
                        </div>
                        <div class="mb-3">
                            <label for="order-date" class="form-label">下单日期</label>
                            <input type="date" class="form-control" id="order-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">客户名称</label>
                            <input type="text" class="form-control readonly-field" id="order-customer" readonly>
                            <div class="form-text">自动引用当前登录用户</div>
                        </div>
                        <div class="mb-3">
                            <label for="order-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="order-notes" rows="3"></textarea>
                            <div class="form-text">可选填写，用于记录订单相关信息</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-order">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑订单模态框 -->
    <div class="modal fade" id="editOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑订单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-order-form">
                        <input type="hidden" id="edit-order-id">
                        <div class="mb-3">
                            <label for="edit-order-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="edit-order-product" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-order-quantity" class="form-label">下单数量</label>
                            <input type="number" class="form-control" id="edit-order-quantity" required>
                            <div class="max-quantity-help" id="edit-order-quantity-help"></div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-order-date" class="form-label">下单日期</label>
                            <input type="date" class="form-control" id="edit-order-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">客户名称</label>
                            <input type="text" class="form-control readonly-field" id="edit-order-customer" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-order-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="edit-order-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="update-order">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增生产记录模态框 -->
    <div class="modal fade" id="addProductionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增生产记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="production-form">
                        <div class="mb-3">
                            <label for="production-id" class="form-label">生产批次</label>
                            <input type="text" class="form-control" id="production-id">
                            <div class="form-text">可自定义生产批次，如不填写将自动生成。不同订单的生产批次可以重复。</div>
                        </div>
                        <div class="mb-3">
                            <label for="production-order" class="form-label">订单编号</label>
                            <select class="form-control" id="production-order" required>
                                <option value="">请选择订单</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="production-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="production-product" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="production-quantity" class="form-label">生产数量</label>
                            <input type="number" class="form-control" id="production-quantity" required>
                            <div class="form-text" id="production-quantity-help">最大可生产数量: 0</div>
                        </div>
                        <div class="mb-3">
                            <label for="production-date" class="form-label">生产日期</label>
                            <input type="date" class="form-control" id="production-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">负责人</label>
                            <input type="text" class="form-control readonly-field" id="production-manager" readonly>
                            <div class="form-text">自动引用当前登录用户</div>
                        </div>
                        <div class="mb-3">
                            <label for="production-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="production-notes" rows="3"></textarea>
                            <div class="form-text">可选填写，用于记录生产相关信息</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-production">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑生产记录模态框 -->
    <div class="modal fade" id="editProductionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑生产记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-production-form">
                        <input type="hidden" id="edit-production-id">
                        <div class="mb-3">
                            <label for="edit-production-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="edit-production-product" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-production-quantity" class="form-label">生产数量</label>
                            <input type="number" class="form-control" id="edit-production-quantity" required>
                            <div class="max-quantity-help" id="edit-production-quantity-help"></div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-production-date" class="form-label">生产日期</label>
                            <input type="date" class="form-control" id="edit-production-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">负责人</label>
                            <input type="text" class="form-control readonly-field" id="edit-production-manager" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-production-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="edit-production-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="update-production">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增入库记录模态框 -->
    <div class="modal fade" id="addStorageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增入库记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="storage-form">
                        <div class="mb-3">
                            <label for="storage-id" class="form-label">入库单号</label>
                            <input type="text" class="form-control" id="storage-id">
                            <div class="form-text">可自定义入库单号，如不填写将自动生成</div>
                        </div>
                        <div class="mb-3">
                            <label for="storage-production" class="form-label">生产批次</label>
                            <select class="form-control" id="storage-production" required>
                                <option value="">请选择生产批次</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="storage-order" class="form-label">订单编号</label>
                            <input type="text" class="form-control" id="storage-order" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="storage-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="storage-product" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="storage-quantity" class="form-label">入库数量</label>
                            <input type="number" class="form-control" id="storage-quantity" required>
                            <div class="form-text" id="storage-quantity-help">最大可入库数量: 0</div>
                        </div>
                        <div class="mb-3">
                            <label for="storage-date" class="form-label">入库日期</label>
                            <input type="date" class="form-control" id="storage-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">负责人</label>
                            <input type="text" class="form-control readonly-field" id="storage-manager" readonly>
                            <div class="form-text">自动引用当前登录用户</div>
                        </div>
                        <div class="mb-3">
                            <label for="storage-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="storage-notes" rows="3"></textarea>
                            <div class="form-text">可选填写，用于记录入库相关信息</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-storage">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑入库记录模态框 -->
    <div class="modal fade" id="editStorageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑入库记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-storage-form">
                        <input type="hidden" id="edit-storage-id">
                        <div class="mb-3">
                            <label for="edit-storage-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="edit-storage-product" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-storage-quantity" class="form-label">入库数量</label>
                            <input type="number" class="form-control" id="edit-storage-quantity" required>
                            <div class="max-quantity-help" id="edit-storage-quantity-help"></div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-storage-date" class="form-label">入库日期</label>
                            <input type="date" class="form-control" id="edit-storage-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">负责人</label>
                            <input type="text" class="form-control readonly-field" id="edit-storage-manager" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-storage-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="edit-storage-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="update-storage">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增出库记录模态框 -->
    <div class="modal fade" id="addShipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增出库记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="shipment-form">
                        <div class="mb-3">
                            <label for="shipment-id" class="form-label">出库单号</label>
                            <input type="text" class="form-control" id="shipment-id">
                            <div class="form-text">可自定义出库单号，如不填写将自动生成</div>
                        </div>
                        <div class="mb-3">
                            <label for="shipment-storage" class="form-label">入库单号</label>
                            <select class="form-control" id="shipment-storage" required>
                                <option value="">请选择入库单号</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="shipment-production" class="form-label">生产批次</label>
                            <input type="text" class="form-control" id="shipment-production" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="shipment-order" class="form-label">订单编号</label>
                            <input type="text" class="form-control" id="shipment-order" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="shipment-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="shipment-product" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="shipment-quantity" class="form-label">出库数量</label>
                            <input type="number" class="form-control" id="shipment-quantity" required>
                            <div class="form-text" id="shipment-quantity-help">最大可出库数量: 0</div>
                        </div>
                        <div class="mb-3">
                            <label for="shipment-date" class="form-label">出库日期</label>
                            <input type="date" class="form-control" id="shipment-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">客户名称</label>
                            <input type="text" class="form-control readonly-field" id="shipment-customer" readonly>
                            <div class="form-text">自动引用当前登录用户</div>
                        </div>
                        <div class="mb-3">
                            <label for="shipment-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="shipment-notes" rows="3"></textarea>
                            <div class="form-text">可选填写，用于记录出库相关信息</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-shipment">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑出库记录模态框 -->
    <div class="modal fade" id="editShipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑出库记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-shipment-form">
                        <input type="hidden" id="edit-shipment-id">
                        <div class="mb-3">
                            <label for="edit-shipment-product" class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="edit-shipment-product" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-shipment-quantity" class="form-label">出库数量</label>
                            <input type="number" class="form-control" id="edit-shipment-quantity" required>
                            <div class="max-quantity-help" id="edit-shipment-quantity-help"></div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-shipment-date" class="form-label">出库日期</label>
                            <input type="date" class="form-control" id="edit-shipment-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">客户名称</label>
                            <input type="text" class="form-control readonly-field" id="edit-shipment-customer" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-shipment-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="edit-shipment-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="update-shipment">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据导入模态框 -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">从Excel导入数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="import-type" class="form-label">选择导入数据类型</label>
                        <select class="form-control" id="import-type">
                            <option value="all">所有数据</option>
                            <option value="orders">订单数据</option>
                            <option value="productions">生产数据</option>
                            <option value="storages">入库数据</option>
                            <option value="shipments">出库数据</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="import-file" class="form-label">选择Excel文件</label>
                        <input type="file" class="form-control" id="import-file" accept=".xlsx, .xls">
                        <div class="form-text">请选择要导入的Excel文件</div>
                    </div>
                    <div class="alert alert-warning">
                        <strong>注意：</strong>导入数据将覆盖现有数据，请谨慎操作！
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="importData()">导入数据</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户管理模态框 -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">用户管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-success mb-3" onclick="showAddUserModal()">添加新用户</button>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <th>角色</th>
                                    <th>权限</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-user-form">
                        <div class="mb-3">
                            <label for="new-username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="new-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="user-role-select" class="form-label">角色</label>
                            <select class="form-control" id="user-role-select" required>
                                <option value="admin">管理员</option>
                                <option value="production_manager">生产主管</option>
                                <option value="storage_manager">入库员</option>
                                <option value="warehouse_manager">仓库主管</option>
                                <option value="sales">销售员</option>
                                <option value="viewer">查看员</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addNewUser()">添加用户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 无操作警告模态框 -->
    <div id="inactive-warning" class="inactive-warning" style="display: none;">
        <h4>系统即将自动退出</h4>
        <p>由于长时间无操作，系统将在 <span id="countdown">30</span> 秒后自动退出。</p>
        <button class="btn btn-primary" onclick="stayLoggedIn()">继续使用</button>
    </div>
    <div id="overlay" class="overlay" style="display: none;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入SheetJS库 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // Google Apps Script Web App URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzJmb7Q71q8UuNSJbDJSq1hsAK4bL8DY6Fv0ZuyuI3geYq4tl60wEUN7G8Yi0I7b6yPUA/exec';

        // 用户和权限管理
        const USER_ROLES = {
            admin: {
                name: '管理员',
                permissions: ['order_manage', 'production_manage', 'storage_manage', 'shipment_manage', 'user_manage', 'view_all', 'data_export_import', 'delete_data', 'edit_data']
            },
            production_manager: {
                name: '生产主管',
                permissions: ['production_manage', 'view_all']
            },
            storage_manager: {
                name: '入库员',
                permissions: ['storage_manage', 'view_all']
            },
            warehouse_manager: {
                name: '仓库主管',
                permissions: ['shipment_manage', 'view_all']
            },
            sales: {
                name: '销售员',
                permissions: ['order_manage', 'view_all']
            },
            viewer: {
                name: '查看员',
                permissions: ['view_all']
            }
        };

        // 默认用户数据
        const defaultUsers = [
            { username: 'admin', password: 'admin123', role: 'admin' },
            { username: 'production', password: 'prod123', role: 'production_manager' },
            { username: 'storage', password: 'storage123', role: 'storage_manager' },
            { username: 'warehouse', password: 'ware123', role: 'warehouse_manager' },
            { username: 'sales', password: 'sales123', role: 'sales' }
        ];

        // 数据库
        let database = {
            users: JSON.parse(localStorage.getItem('inventory_users')) || defaultUsers,
            orders: [],
            productions: [],
            storages: [],
            shipments: []
        };

        let currentUser = null;
        
        // 无操作自动退出相关变量
        let inactivityTimer;
        let countdownTimer;
        let countdownSeconds = 30;
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30分钟

        // 改进的API调用函数 - 使用JSON格式
        async function callGoogleAppsScript(action, data = {}) {
            showLoading();
            
            try {
                console.log(`开始API调用: ${action}`, data);
                
                // 使用JSON格式（推荐）
                const payload = {
                    action: action,
                    data: data,
                    user: currentUser ? currentUser.username : 'anonymous',
                    timestamp: new Date().toISOString()
                };
                
                console.log('发送的payload:', payload);
                
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('响应状态:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                const resultText = await response.text();
                console.log('原始响应文本:', resultText);
                
                let result;
                try {
                    result = JSON.parse(resultText);
                } catch (parseError) {
                    console.error('JSON解析错误:', parseError);
                    throw new Error('服务器返回了无效的JSON格式');
                }
                
                console.log('解析后的结果:', result);
                
                hideLoading();
                
                if (result.success) {
                    console.log(`API调用 ${action} 成功`);
                    return result.data;
                } else {
                    throw new Error(result.error || '发生未知错误');
                }
            } catch (error) {
                hideLoading();
                console.error('API调用错误:', error);
                
                // 后备方案：使用本地存储
                if (action === 'getAllData') {
                    console.log('使用本地存储作为后备方案');
                    return getDataFromLocalStorage();
                }
                
                // 对于保存操作，如果失败则只保存到本地
                if (action === 'saveAllData') {
                    console.log('服务器保存失败，数据已保存到本地');
                    return { success: false, error: '使用本地存储' };
                }
                
                throw error;
            }
        }

        // 从本地存储获取数据（后备方案）
        function getDataFromLocalStorage() {
            return {
                orders: JSON.parse(localStorage.getItem('orders')) || [],
                productions: JSON.parse(localStorage.getItem('productions')) || [],
                storages: JSON.parse(localStorage.getItem('storages')) || [],
                shipments: JSON.parse(localStorage.getItem('shipments')) || []
            };
        }

        // 显示加载遮罩
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        // 隐藏加载遮罩
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // 加载所有数据
        async function loadAllData() {
            try {
                console.log('开始加载数据...');
                const data = await callGoogleAppsScript('getAllData');
                
                // 检查数据格式是否正确
                if (data && (data.orders || data.productions || data.storages || data.shipments)) {
                    database.orders = data.orders || [];
                    database.productions = data.productions || [];
                    database.storages = data.storages || [];
                    database.shipments = data.shipments || [];
                    
                    console.log('从服务器加载的数据:', {
                        订单数: database.orders.length,
                        生产记录数: database.productions.length,
                        入库记录数: database.storages.length,
                        出库记录数: database.shipments.length
                    });
                    
                    // 同时更新本地存储作为缓存
                    localStorage.setItem('orders', JSON.stringify(database.orders));
                    localStorage.setItem('productions', JSON.stringify(database.productions));
                    localStorage.setItem('storages', JSON.stringify(database.storages));
                    localStorage.setItem('shipments', JSON.stringify(database.shipments));
                    
                    updateUI();
                    console.log('数据从服务器加载成功');
                } else {
                    console.warn('服务器返回数据格式不正确，使用本地数据');
                    throw new Error('服务器返回数据格式不正确');
                }
            } catch (error) {
                console.error('从服务器加载数据失败:', error);
                // 使用本地存储的数据
                const localData = getDataFromLocalStorage();
                database.orders = localData.orders;
                database.productions = localData.productions;
                database.storages = localData.storages;
                database.shipments = localData.shipments;
                updateUI();
                alert('连接到服务器失败，使用本地缓存数据。部分功能可能受限。');
            }
        }

        // 保存数据到Google Apps Script - 改进版本
        async function saveData() {
            try {
                console.log('开始保存数据...', {
                    订单数: database.orders.length,
                    生产记录数: database.productions.length,
                    入库记录数: database.storages.length,
                    出库记录数: database.shipments.length
                });
                
                // 先保存到本地存储
                localStorage.setItem('orders', JSON.stringify(database.orders));
                localStorage.setItem('productions', JSON.stringify(database.productions));
                localStorage.setItem('storages', JSON.stringify(database.storages));
                localStorage.setItem('shipments', JSON.stringify(database.shipments));
                
                console.log('数据已保存到本地存储');
                
                // 然后尝试保存到服务器
                const result = await callGoogleAppsScript('saveAllData', {
                    orders: database.orders,
                    productions: database.productions,
                    storages: database.storages,
                    shipments: database.shipments
                });
                
                updateUI();
                
                if (result && result.success) {
                    console.log('数据保存到服务器成功');
                    return true;
                } else {
                    console.log('数据已保存到本地，但服务器保存失败');
                    return false;
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                // 即使服务器保存失败，本地数据也已经保存了
                updateUI();
                alert('保存到服务器失败，数据已保存到本地缓存。');
                return false;
            }
        }

        // 重置无操作计时器
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(countdownTimer);
            
            // 隐藏警告模态框
            document.getElementById('inactive-warning').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            
            // 重新设置计时器
            inactivityTimer = setTimeout(showInactivityWarning, INACTIVITY_TIMEOUT);
        }

        // 显示无操作警告
        function showInactivityWarning() {
            countdownSeconds = 30;
            document.getElementById('countdown').textContent = countdownSeconds;
            document.getElementById('inactive-warning').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            
            countdownTimer = setInterval(function() {
                countdownSeconds--;
                document.getElementById('countdown').textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    logout();
                }
            }, 1000);
        }

        // 继续使用系统
        function stayLoggedIn() {
            resetInactivityTimer();
        }

        // 设置无操作监听器
        function setupInactivityListener() {
            // 监听用户活动
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
            
            // 初始化计时器
            resetInactivityTimer();
        }

        // 测试连接函数
        async function testConnection() {
            console.log('开始测试连接...');
            try {
                const testData = await callGoogleAppsScript('getAllData');
                console.log('连接测试结果:', testData);
                alert(`连接测试成功！\n订单数: ${testData.orders?.length || 0}\n生产记录数: ${testData.productions?.length || 0}`);
            } catch (error) {
                console.error('连接测试失败:', error);
                alert('连接测试失败: ' + error.message);
            }
        }

        // 清除本地数据函数
        function clearLocalData() {
            if (confirm('确定要清除所有本地数据吗？这将不会影响服务器数据。')) {
                localStorage.removeItem('orders');
                localStorage.removeItem('productions');
                localStorage.removeItem('storages');
                localStorage.removeItem('shipments');
                localStorage.removeItem('currentUser');
                alert('本地数据已清除，页面将刷新');
                location.reload();
            }
        }

        // Excel导出导入功能
        // 导出所有数据到Excel（包含多个工作表）
        function exportAllData() {
            if (!hasPermission('data_export_import')) {
                alert('您没有权限导出数据！');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const today = new Date().toISOString().split('T')[0];
            
            // 1. 订单数据工作表
            const ordersData = database.orders.map(order => {
                // 计算已生产数量和未生产数量
                const relatedProductions = database.productions.filter(p => p.orderId === order.id && p.product === order.product);
                const producedQuantity = relatedProductions.reduce((sum, p) => {
                    const qty = parseInt(p.quantity) || 0;
                    return sum + qty;
                }, 0);
                const orderQty = parseInt(order.quantity) || 0;
                const remainingQuantity = orderQty - producedQuantity;
                
                return {
                    '订单编号': order.id,
                    '产品名称': order.product,
                    '下单数量': order.quantity,
                    '已生产数量': producedQuantity,
                    '未生产数量': remainingQuantity,
                    '下单日期': order.date,
                    '客户名称': order.customer,
                    '备注': order.notes || '',
                    '状态': remainingQuantity === 0 ? '已完成' : '进行中'
                };
            });
            
            if (ordersData.length > 0) {
                const ordersWS = XLSX.utils.json_to_sheet(ordersData);
                XLSX.utils.book_append_sheet(wb, ordersWS, '订单数据');
            }
            
            // 2. 生产数据工作表
            const productionsData = database.productions.map(production => {
                // 计算已入库数量和未入库数量
                const relatedStorages = database.storages.filter(s => s.productionId === production.id && s.product === production.product);
                const storedQuantity = relatedStorages.reduce((sum, s) => {
                    const qty = parseInt(s.quantity) || 0;
                    return sum + qty;
                }, 0);
                const productionQty = parseInt(production.quantity) || 0;
                const remainingQuantity = productionQty - storedQuantity;
                
                // 获取订单信息
                const order = database.orders.find(o => o.id === production.orderId && o.product === production.product);
                const orderQuantity = order ? order.quantity : 0;
                
                return {
                    '生产批次': production.id,
                    '订单编号': production.orderId,
                    '产品名称': production.product,
                    '下单数量': orderQuantity,
                    '生产数量': production.quantity,
                    '已入库数量': storedQuantity,
                    '未入库数量': remainingQuantity,
                    '生产日期': production.date,
                    '负责人': production.manager,
                    '备注': production.notes || ''
                };
            });
            
            if (productionsData.length > 0) {
                const productionsWS = XLSX.utils.json_to_sheet(productionsData);
                XLSX.utils.book_append_sheet(wb, productionsWS, '生产数据');
            }
            
            // 3. 入库数据工作表
            const storagesData = database.storages.map(storage => {
                // 计算已出库数量和未出库数量
                const relatedShipments = database.shipments.filter(s => s.storageId === storage.id && s.product === storage.product);
                const shippedQuantity = relatedShipments.reduce((sum, s) => {
                    const qty = parseInt(s.quantity) || 0;
                    return sum + qty;
                }, 0);
                const storageQty = parseInt(storage.quantity) || 0;
                const remainingQuantity = storageQty - shippedQuantity;
                
                // 获取生产信息
                const production = database.productions.find(p => p.id === storage.productionId && p.product === storage.product);
                const productionQuantity = production ? production.quantity : 0;
                
                return {
                    '入库单号': storage.id,
                    '生产批次': storage.productionId,
                    '订单编号': storage.orderId,
                    '产品名称': storage.product,
                    '生产数量': productionQuantity,
                    '入库数量': storage.quantity,
                    '已出库数量': shippedQuantity,
                    '未出库数量': remainingQuantity,
                    '入库日期': storage.date,
                    '负责人': storage.manager,
                    '备注': storage.notes || ''
                };
            });
            
            if (storagesData.length > 0) {
                const storagesWS = XLSX.utils.json_to_sheet(storagesData);
                XLSX.utils.book_append_sheet(wb, storagesWS, '入库数据');
            }
            
            // 4. 出库数据工作表
            const shipmentsData = database.shipments.map(shipment => {
                // 获取订单、生产和入库信息
                const order = database.orders.find(o => o.id === shipment.orderId && o.product === shipment.product);
                const production = database.productions.find(p => p.id === shipment.productionId && p.product === shipment.product);
                const storage = database.storages.find(s => s.id === shipment.storageId && s.product === shipment.product);
                
                const orderQuantity = order ? order.quantity : 0;
                const productionQuantity = production ? production.quantity : 0;
                const storageQuantity = storage ? storage.quantity : 0;
                
                return {
                    '出库单号': shipment.id,
                    '入库单号': shipment.storageId,
                    '生产批次': shipment.productionId,
                    '订单编号': shipment.orderId,
                    '产品名称': shipment.product,
                    '入库数量': storageQuantity,
                    '出库数量': shipment.quantity,
                    '出库日期': shipment.date,
                    '客户名称': shipment.customer,
                    '备注': shipment.notes || ''
                };
            });
            
            if (shipmentsData.length > 0) {
                const shipmentsWS = XLSX.utils.json_to_sheet(shipmentsData);
                XLSX.utils.book_append_sheet(wb, shipmentsWS, '出库数据');
            }
            
            // 5. 库存统计工作表
            const allProducts = [...new Set([
                ...database.orders.map(o => o.product),
                ...database.productions.map(p => p.product),
                ...database.storages.map(s => s.product),
                ...database.shipments.map(s => s.product)
            ])];
            
            const inventoryData = allProducts.map(product => {
                const totalOrdered = database.orders
                    .filter(o => o.product === product)
                    .reduce((sum, o) => {
                        const qty = parseInt(o.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                const totalProduced = database.productions
                    .filter(p => p.product === product)
                    .reduce((sum, p) => {
                        const qty = parseInt(p.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                const totalStored = database.storages
                    .filter(s => s.product === product)
                    .reduce((sum, s) => {
                        const qty = parseInt(s.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                const totalShipped = database.shipments
                    .filter(s => s.product === product)
                    .reduce((sum, s) => {
                        const qty = parseInt(s.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                const orderedNotProduced = totalOrdered - totalProduced;
                const producedNotStored = totalProduced - totalStored;
                const storedNotShipped = totalStored - totalShipped;
                const currentStock = storedNotShipped;
                
                return {
                    '产品名称': product,
                    '总下单数量': totalOrdered,
                    '总生产数量': totalProduced,
                    '总入库数量': totalStored,
                    '总出库数量': totalShipped,
                    '已下单未生产': orderedNotProduced,
                    '已生产未入库': producedNotStored,
                    '已入库未出库': storedNotShipped,
                    '当前库存': currentStock
                };
            });
            
            if (inventoryData.length > 0) {
                const inventoryWS = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(wb, inventoryWS, '库存统计');
            }
            
            // 6. 系统概览工作表
            const summaryData = [{
                '导出时间': new Date().toLocaleString('zh-CN'),
                '总订单数': database.orders.length,
                '总生产记录数': database.productions.length,
                '总入库记录数': database.storages.length,
                '总出库记录数': database.shipments.length,
                '产品种类数': allProducts.length,
                '数据截止日期': today
            }];
            
            const summaryWS = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWS, '系统概览');
            
            // 导出文件
            XLSX.writeFile(wb, `库存管理系统完整数据_${today}.xlsx`);
            alert('数据已成功导出到Excel文件！文件包含多个工作表：系统概览、订单数据、生产数据、入库数据、出库数据、库存统计。');
        }

        // 显示导入模态框
        function showImportModal() {
            if (!hasPermission('data_export_import')) {
                alert('您没有权限导入数据！');
                return;
            }
            
            new bootstrap.Modal(document.getElementById('importModal')).show();
        }

        // 导入数据
        function importData() {
            if (!hasPermission('data_export_import')) {
                alert('您没有权限导入数据！');
                return;
            }
            
            const fileInput = document.getElementById('import-file');
            const importType = document.getElementById('import-type').value;
            
            if (!fileInput.files.length) {
                alert('请选择要导入的Excel文件！');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let importedCount = 0;
                    
                    if (importType === 'all' || importType === 'orders') {
                        const ordersSheet = workbook.Sheets['订单数据'];
                        if (ordersSheet) {
                            const ordersData = XLSX.utils.sheet_to_json(ordersSheet);
                            if (ordersData.length > 0) {
                                database.orders = ordersData.map(item => ({
                                    id: item['订单编号'] || generateId(),
                                    product: item['产品名称'],
                                    quantity: parseInt(item['下单数量']),
                                    date: item['下单日期'],
                                    customer: item['客户名称'],
                                    notes: item['备注'] || ''
                                }));
                                importedCount += ordersData.length;
                            }
                        }
                    }
                    
                    if (importType === 'all' || importType === 'productions') {
                        const productionsSheet = workbook.Sheets['生产数据'];
                        if (productionsSheet) {
                            const productionsData = XLSX.utils.sheet_to_json(productionsSheet);
                            if (productionsData.length > 0) {
                                database.productions = productionsData.map(item => ({
                                    id: item['生产批次'] || generateId(),
                                    orderId: item['订单编号'],
                                    product: item['产品名称'],
                                    quantity: parseInt(item['生产数量']),
                                    date: item['生产日期'],
                                    manager: item['负责人'],
                                    notes: item['备注'] || ''
                                }));
                                importedCount += productionsData.length;
                            }
                        }
                    }
                    
                    if (importType === 'all' || importType === 'storages') {
                        const storagesSheet = workbook.Sheets['入库数据'];
                        if (storagesSheet) {
                            const storagesData = XLSX.utils.sheet_to_json(storagesSheet);
                            if (storagesData.length > 0) {
                                database.storages = storagesData.map(item => ({
                                    id: item['入库单号'] || generateId(),
                                    productionId: item['生产批次'],
                                    orderId: item['订单编号'],
                                    product: item['产品名称'],
                                    quantity: parseInt(item['入库数量']),
                                    date: item['入库日期'],
                                    manager: item['负责人'],
                                    notes: item['备注'] || ''
                                }));
                                importedCount += storagesData.length;
                            }
                        }
                    }
                    
                    if (importType === 'all' || importType === 'shipments') {
                        const shipmentsSheet = workbook.Sheets['出库数据'];
                        if (shipmentsSheet) {
                            const shipmentsData = XLSX.utils.sheet_to_json(shipmentsSheet);
                            if (shipmentsData.length > 0) {
                                database.shipments = shipmentsData.map(item => ({
                                    id: item['出库单号'] || generateId(),
                                    storageId: item['入库单号'],
                                    productionId: item['生产批次'],
                                    orderId: item['订单编号'],
                                    product: item['产品名称'],
                                    quantity: parseInt(item['出库数量']),
                                    date: item['出库日期'],
                                    customer: item['客户名称'],
                                    notes: item['备注'] || ''
                                }));
                                importedCount += shipmentsData.length;
                            }
                        }
                    }
                    
                    saveData();
                    bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                    alert(`成功导入 ${importedCount} 条数据！`);
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('导入错误:', error);
                    alert('导入失败，请检查文件格式是否正确！');
                }
            };
            
            reader.onerror = function() {
                alert('文件读取失败！');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 权限检查函数
        function hasPermission(permission) {
            if (!currentUser) return false;
            const userRole = USER_ROLES[currentUser.role];
            return userRole.permissions.includes(permission);
        }

        // 登录功能
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = database.users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainSystem();
            } else {
                alert('用户名或密码错误！');
            }
        });

        // 显示主系统
        function showMainSystem() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-system').style.display = 'block';
            
            // 更新用户界面
            document.getElementById('current-user').textContent = currentUser.username;
            document.getElementById('user-role').textContent = USER_ROLES[currentUser.role].name;
            
            // 根据权限显示/隐藏功能
            updateUIByPermissions();
            
            // 加载数据
            loadAllData();
            
            // 设置无操作监听器
            setupInactivityListener();
        }

        // 根据权限更新界面
        function updateUIByPermissions() {
            // 用户管理按钮
            document.getElementById('user-management-btn').style.display = 
                hasPermission('user_manage') ? 'block' : 'none';
            
            // 订单管理权限
            document.getElementById('add-order-btn').style.display = 
                hasPermission('order_manage') ? 'block' : 'none';
            
            // 生产管理权限
            document.getElementById('add-production-btn').style.display = 
                hasPermission('production_manage') ? 'block' : 'none';
            
            // 入库管理权限
            document.getElementById('add-storage-btn').style.display = 
                hasPermission('storage_manage') ? 'block' : 'none';
            
            // 出库管理权限
            document.getElementById('add-shipment-btn').style.display = 
                hasPermission('shipment_manage') ? 'block' : 'none';
            
            // Excel导出导入权限（仅管理员可见）
            document.getElementById('export-import-section').style.display = 
                hasPermission('data_export_import') ? 'block' : 'none';
        }

        // 退出登录
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('main-system').style.display = 'none';
            document.getElementById('login-form').reset();
            
            // 清除计时器
            clearTimeout(inactivityTimer);
            clearTimeout(countdownTimer);
        }

        // 用户管理
        function showUserManagement() {
            updateUserTable();
            new bootstrap.Modal(document.getElementById('userManagementModal')).show();
        }

        function updateUserTable() {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            
            database.users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${USER_ROLES[user.role].name}</td>
                    <td>${USER_ROLES[user.role].permissions.join(', ')}</td>
                    <td><span class="badge bg-success">激活</span></td>
                    <td>
                        ${user.username !== 'admin' ? `
                        <button class="btn btn-sm btn-warning" onclick="editUser('${user.username}')">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.username}')">删除</button>
                        ` : '<span class="text-muted">系统管理员</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddUserModal() {
            new bootstrap.Modal(document.getElementById('addUserModal')).show();
        }

        function addNewUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('user-role-select').value;
            
            if (database.users.find(u => u.username === username)) {
                alert('用户名已存在！');
                return;
            }
            
            database.users.push({ username, password, role });
            localStorage.setItem('inventory_users', JSON.stringify(database.users));
            
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            document.getElementById('add-user-form').reset();
            updateUserTable();
        }

        function deleteUser(username) {
            if (confirm(`确定要删除用户 ${username} 吗？`)) {
                database.users = database.users.filter(u => u.username !== username);
                localStorage.setItem('inventory_users', JSON.stringify(database.users));
                updateUserTable();
            }
        }

        // 检查是否已登录
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainSystem();
                } catch (e) {
                    // 如果JSON解析失败，清除无效数据并显示登录界面
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // 删除订单
        function deleteOrder(id) {
            if (!hasPermission('delete_data')) {
                alert('您没有权限删除订单！');
                return;
            }
            
            if (confirm('确定要删除此订单吗？')) {
                const hasProduction = database.productions.some(production => production.orderId === id);
                if (hasProduction) {
                    alert('该订单已有生产记录，无法删除！');
                    return;
                }
                
                database.orders = database.orders.filter(order => order.id !== id);
                saveData();
            }
        }

        // 编辑订单
        function editOrder(id) {
            if (!hasPermission('edit_data')) {
                alert('您没有权限编辑订单！');
                return;
            }
            
            const order = database.orders.find(order => order.id === id);
            if (order) {
                document.getElementById('edit-order-id').value = order.id;
                document.getElementById('edit-order-product').value = order.product;
                document.getElementById('edit-order-quantity').value = order.quantity;
                document.getElementById('edit-order-date').value = order.date;
                document.getElementById('edit-order-customer').value = order.customer;
                document.getElementById('edit-order-notes').value = order.notes || '';
                
                // 计算当前已生产数量
                const relatedProductions = database.productions.filter(p => p.orderId === order.id && p.product === order.product);
                const producedQuantity = relatedProductions.reduce((sum, p) => sum + parseInt(p.quantity), 0);
                
                // 设置最大可编辑数量提示
                const helpText = `当前已生产数量: ${producedQuantity}，最大可编辑数量: ${parseInt(order.quantity) + producedQuantity}`;
                document.getElementById('edit-order-quantity-help').textContent = helpText;
                
                new bootstrap.Modal(document.getElementById('editOrderModal')).show();
            }
        }

        // 更新订单
        document.getElementById('update-order')?.addEventListener('click', function() {
            const id = document.getElementById('edit-order-id').value;
            const product = document.getElementById('edit-order-product').value;
            const quantity = document.getElementById('edit-order-quantity').value;
            const date = document.getElementById('edit-order-date').value;
            const customer = document.getElementById('edit-order-customer').value;
            const notes = document.getElementById('edit-order-notes').value;
            
            if (product && quantity && date && customer) {
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                const orderIndex = database.orders.findIndex(order => order.id === id);
                if (orderIndex !== -1) {
                    const originalOrder = database.orders[orderIndex];
                    
                    // 计算当前已生产数量
                    const relatedProductions = database.productions.filter(p => p.orderId === id && p.product === product);
                    const producedQuantity = relatedProductions.reduce((sum, p) => {
                        const qty = parseInt(p.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                    // 验证编辑后的数量不能小于已生产数量
                    if (quantityNum < producedQuantity) {
                        alert(`编辑后的下单数量不能小于已生产数量 ${producedQuantity}`);
                        return;
                    }
                    
                    database.orders[orderIndex] = {
                        ...database.orders[orderIndex],
                        product,
                        quantity: quantityNum,
                        date,
                        customer,
                        notes
                    };
                    
                    saveData();
                    bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
                }
            } else {
                alert('请填写所有必填字段');
            }
        });

        // 删除生产记录
        function deleteProduction(id) {
            if (!hasPermission('delete_data')) {
                alert('您没有权限删除生产记录！');
                return;
            }
            
            if (confirm('确定要删除此生产记录吗？')) {
                const hasStorage = database.storages.some(storage => storage.productionId === id);
                if (hasStorage) {
                    alert('该生产记录已有入库记录，无法删除！');
                    return;
                }
                
                database.productions = database.productions.filter(production => production.id !== id);
                saveData();
            }
        }

        // 编辑生产记录
        function editProduction(id) {
            if (!hasPermission('edit_data')) {
                alert('您没有权限编辑生产记录！');
                return;
            }
            
            const production = database.productions.find(production => production.id === id);
            if (production) {
                document.getElementById('edit-production-id').value = production.id;
                document.getElementById('edit-production-product').value = production.product;
                document.getElementById('edit-production-quantity').value = production.quantity;
                document.getElementById('edit-production-date').value = production.date;
                document.getElementById('edit-production-manager').value = production.manager;
                document.getElementById('edit-production-notes').value = production.notes || '';
                
                // 获取对应的订单信息
                const order = database.orders.find(o => o.id === production.orderId && o.product === production.product);
                if (order) {
                    // 计算当前已入库数量
                    const relatedStorages = database.storages.filter(s => s.productionId === production.id && s.product === production.product);
                    const storedQuantity = relatedStorages.reduce((sum, s) => {
                        const qty = parseInt(s.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                    // 计算其他生产记录的生产数量
                    const otherProductions = database.productions.filter(p => 
                        p.orderId === production.orderId && p.product === production.product && p.id !== production.id
                    );
                    const otherProducedQuantity = otherProductions.reduce((sum, p) => {
                        const qty = parseInt(p.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                    // 计算最大可编辑数量
                    const orderQty = parseInt(order.quantity) || 0;
                    const maxQuantity = orderQty - otherProducedQuantity;
                    
                    // 设置最大可编辑数量提示
                    const helpText = `订单总数量: ${order.quantity}，当前已入库数量: ${storedQuantity}，最大可编辑数量: ${maxQuantity}`;
                    document.getElementById('edit-production-quantity-help').textContent = helpText;
                }
                
                new bootstrap.Modal(document.getElementById('editProductionModal')).show();
            }
        }

        // 更新生产记录
        document.getElementById('update-production')?.addEventListener('click', function() {
            const id = document.getElementById('edit-production-id').value;
            const quantity = document.getElementById('edit-production-quantity').value;
            const date = document.getElementById('edit-production-date').value;
            const manager = document.getElementById('edit-production-manager').value;
            const notes = document.getElementById('edit-production-notes').value;
            
            if (quantity && date && manager) {
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                const productionIndex = database.productions.findIndex(production => production.id === id);
                if (productionIndex !== -1) {
                    const production = database.productions[productionIndex];
                    
                    // 获取对应的订单信息
                    const order = database.orders.find(o => o.id === production.orderId && o.product === production.product);
                    if (order) {
                        // 计算当前已入库数量
                        const relatedStorages = database.storages.filter(s => s.productionId === production.id && s.product === production.product);
                        const storedQuantity = relatedStorages.reduce((sum, s) => {
                            const qty = parseInt(s.quantity) || 0;
                            return sum + qty;
                        }, 0);
                        
                        // 计算其他生产记录的生产数量
                        const otherProductions = database.productions.filter(p => 
                            p.orderId === production.orderId && p.product === production.product && p.id !== production.id
                        );
                        const otherProducedQuantity = otherProductions.reduce((sum, p) => {
                            const qty = parseInt(p.quantity) || 0;
                            return sum + qty;
                        }, 0);
                        
                        // 计算最大可编辑数量
                        const orderQty = parseInt(order.quantity) || 0;
                        const maxQuantity = orderQty - otherProducedQuantity;
                        
                        // 验证编辑后的数量不能小于已入库数量
                        if (quantityNum < storedQuantity) {
                            alert(`编辑后的生产数量不能小于已入库数量 ${storedQuantity}`);
                            return;
                        }
                        
                        // 验证编辑后的数量不能超过订单总数量减去其他生产记录的数量
                        if (quantityNum > maxQuantity) {
                            alert(`编辑后的生产数量不能超过最大可编辑数量 ${maxQuantity}`);
                            return;
                        }
                    }
                    
                    database.productions[productionIndex] = {
                        ...database.productions[productionIndex],
                        quantity: quantityNum,
                        date,
                        manager,
                        notes
                    };
                    
                    saveData();
                    bootstrap.Modal.getInstance(document.getElementById('editProductionModal')).hide();
                }
            } else {
                alert('请填写所有必填字段');
            }
        });

        // 删除入库记录
        function deleteStorage(id) {
            if (!hasPermission('delete_data')) {
                alert('您没有权限删除入库记录！');
                return;
            }
            
            if (confirm('确定要删除此入库记录吗？')) {
                const hasShipment = database.shipments.some(shipment => shipment.storageId === id);
                if (hasShipment) {
                    alert('该入库记录已有出库记录，无法删除！');
                    return;
                }
                
                database.storages = database.storages.filter(storage => storage.id !== id);
                saveData();
            }
        }

        // 编辑入库记录
        function editStorage(id) {
            if (!hasPermission('edit_data')) {
                alert('您没有权限编辑入库记录！');
                return;
            }
            
            const storage = database.storages.find(storage => storage.id === id);
            if (storage) {
                document.getElementById('edit-storage-id').value = storage.id;
                document.getElementById('edit-storage-product').value = storage.product;
                document.getElementById('edit-storage-quantity').value = storage.quantity;
                document.getElementById('edit-storage-date').value = storage.date;
                document.getElementById('edit-storage-manager').value = storage.manager;
                document.getElementById('edit-storage-notes').value = storage.notes || '';
                
                // 获取对应的生产记录信息
                const production = database.productions.find(p => p.id === storage.productionId && p.product === storage.product);
                if (production) {
                    // 计算当前已出库数量
                    const relatedShipments = database.shipments.filter(s => s.storageId === storage.id && s.product === storage.product);
                    const shippedQuantity = relatedShipments.reduce((sum, s) => {
                        const qty = parseInt(s.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                    // 计算其他入库记录的入库数量
                    const otherStorages = database.storages.filter(s => 
                        s.productionId === storage.productionId && s.product === storage.product && s.id !== storage.id
                    );
                    const otherStoredQuantity = otherStorages.reduce((sum, s) => {
                        const qty = parseInt(s.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                    // 计算最大可编辑数量
                    const productionQty = parseInt(production.quantity) || 0;
                    const maxQuantity = productionQty - otherStoredQuantity;
                    
                    // 设置最大可编辑数量提示
                    const helpText = `生产批次总数量: ${production.quantity}，当前已出库数量: ${shippedQuantity}，最大可编辑数量: ${maxQuantity}`;
                    document.getElementById('edit-storage-quantity-help').textContent = helpText;
                }
                
                new bootstrap.Modal(document.getElementById('editStorageModal')).show();
            }
        }

        // 更新入库记录
        document.getElementById('update-storage')?.addEventListener('click', function() {
            const id = document.getElementById('edit-storage-id').value;
            const quantity = document.getElementById('edit-storage-quantity').value;
            const date = document.getElementById('edit-storage-date').value;
            const manager = document.getElementById('edit-storage-manager').value;
            const notes = document.getElementById('edit-storage-notes').value;
            
            if (quantity && date && manager) {
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                const storageIndex = database.storages.findIndex(storage => storage.id === id);
                if (storageIndex !== -1) {
                    const storage = database.storages[storageIndex];
                    
                    // 获取对应的生产记录信息
                    const production = database.productions.find(p => p.id === storage.productionId && p.product === storage.product);
                    if (production) {
                        // 计算当前已出库数量
                        const relatedShipments = database.shipments.filter(s => s.storageId === storage.id && s.product === storage.product);
                        const shippedQuantity = relatedShipments.reduce((sum, s) => {
                            const qty = parseInt(s.quantity) || 0;
                            return sum + qty;
                        }, 0);
                        
                        // 计算其他入库记录的入库数量
                        const otherStorages = database.storages.filter(s => 
                            s.productionId === storage.productionId && s.product === storage.product && s.id !== storage.id
                        );
                        const otherStoredQuantity = otherStorages.reduce((sum, s) => {
                            const qty = parseInt(s.quantity) || 0;
                            return sum + qty;
                        }, 0);
                        
                        // 计算最大可编辑数量
                        const productionQty = parseInt(production.quantity) || 0;
                        const maxQuantity = productionQty - otherStoredQuantity;
                        
                        // 验证编辑后的数量不能小于已出库数量
                        if (quantityNum < shippedQuantity) {
                            alert(`编辑后的入库数量不能小于已出库数量 ${shippedQuantity}`);
                            return;
                        }
                        
                        // 验证编辑后的数量不能超过最大可编辑数量
                        if (quantityNum > maxQuantity) {
                            alert(`编辑后的入库数量不能超过最大可编辑数量 ${maxQuantity}`);
                            return;
                        }
                    }
                    
                    database.storages[storageIndex] = {
                        ...database.storages[storageIndex],
                        quantity: quantityNum,
                        date,
                        manager,
                        notes
                    };
                    
                    saveData();
                    bootstrap.Modal.getInstance(document.getElementById('editStorageModal')).hide();
                }
            } else {
                alert('请填写所有必填字段');
            }
        });

        // 删除出库记录
        function deleteShipment(id) {
            if (!hasPermission('delete_data')) {
                alert('您没有权限删除出库记录！');
                return;
            }
            
            if (confirm('确定要删除此出库记录吗？')) {
                database.shipments = database.shipments.filter(shipment => shipment.id !== id);
                saveData();
            }
        }

        // 编辑出库记录
        function editShipment(id) {
            if (!hasPermission('edit_data')) {
                alert('您没有权限编辑出库记录！');
                return;
            }
            
            const shipment = database.shipments.find(shipment => shipment.id === id);
            if (shipment) {
                document.getElementById('edit-shipment-id').value = shipment.id;
                document.getElementById('edit-shipment-product').value = shipment.product;
                document.getElementById('edit-shipment-quantity').value = shipment.quantity;
                document.getElementById('edit-shipment-date').value = shipment.date;
                document.getElementById('edit-shipment-customer').value = shipment.customer;
                document.getElementById('edit-shipment-notes').value = shipment.notes || '';
                
                // 获取对应的入库记录信息
                const storage = database.storages.find(s => s.id === shipment.storageId && s.product === shipment.product);
                if (storage) {
                    // 计算其他出库记录的出库数量
                    const otherShipments = database.shipments.filter(s => 
                        s.storageId === shipment.storageId && s.product === shipment.product && s.id !== shipment.id
                    );
                    const otherShippedQuantity = otherShipments.reduce((sum, s) => {
                        const qty = parseInt(s.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    
                    // 计算最大可编辑数量
                    const storageQty = parseInt(storage.quantity) || 0;
                    const maxQuantity = storageQty - otherShippedQuantity;
                    
                    // 设置最大可编辑数量提示
                    const helpText = `入库单总数量: ${storage.quantity}，其他出库数量: ${otherShippedQuantity}，最大可编辑数量: ${maxQuantity}`;
                    document.getElementById('edit-shipment-quantity-help').textContent = helpText;
                }
                
                new bootstrap.Modal(document.getElementById('editShipmentModal')).show();
            }
        }

        // 更新出库记录
        document.getElementById('update-shipment')?.addEventListener('click', function() {
            const id = document.getElementById('edit-shipment-id').value;
            const quantity = document.getElementById('edit-shipment-quantity').value;
            const date = document.getElementById('edit-shipment-date').value;
            const customer = document.getElementById('edit-shipment-customer').value;
            const notes = document.getElementById('edit-shipment-notes').value;
            
            if (quantity && date && customer) {
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                const shipmentIndex = database.shipments.findIndex(shipment => shipment.id === id);
                if (shipmentIndex !== -1) {
                    const shipment = database.shipments[shipmentIndex];
                    
                    // 获取对应的入库记录信息
                    const storage = database.storages.find(s => s.id === shipment.storageId && s.product === shipment.product);
                    if (storage) {
                        // 计算其他出库记录的出库数量
                        const otherShipments = database.shipments.filter(s => 
                            s.storageId === shipment.storageId && s.product === shipment.product && s.id !== shipment.id
                        );
                        const otherShippedQuantity = otherShipments.reduce((sum, s) => {
                            const qty = parseInt(s.quantity) || 0;
                            return sum + qty;
                        }, 0);
                        
                        // 计算最大可编辑数量
                        const storageQty = parseInt(storage.quantity) || 0;
                        const maxQuantity = storageQty - otherShippedQuantity;
                        
                        // 验证编辑后的数量不能超过最大可编辑数量
                        if (quantityNum > maxQuantity) {
                            alert(`编辑后的出库数量不能超过最大可编辑数量 ${maxQuantity}`);
                            return;
                        }
                    }
                    
                    database.shipments[shipmentIndex] = {
                        ...database.shipments[shipmentIndex],
                        quantity: quantityNum,
                        date,
                        customer,
                        notes
                    };
                    
                    saveData();
                    bootstrap.Modal.getInstance(document.getElementById('editShipmentModal')).hide();
                }
            } else {
                alert('请填写所有必填字段');
            }
        });

        // 更新所有界面
        function updateUI() {
            updateOrderTable();
            updateProductionTable();
            updateStorageTable();
            updateShipmentTable();
            updateInventoryTable();
            updateSummaryCards();
            updateInventoryChart();
            updateOrderSelect();
            updateProductionSelect();
            updateStorageSelect();
        }

        // 搜索和排序功能
        // 订单搜索和排序
        function filterAndSortOrders() {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const sortOption = document.getElementById('order-sort').value;
            
            let filteredOrders = database.orders.filter(order => {
                return order.id.toLowerCase().includes(searchTerm) ||
                       order.product.toLowerCase().includes(searchTerm) ||
                       order.customer.toLowerCase().includes(searchTerm) ||
                       (order.notes && order.notes.toLowerCase().includes(searchTerm));
            });
            
            // 排序
            const [sortField, sortDirection] = sortOption.split('-');
            filteredOrders.sort((a, b) => {
                let aValue = a[sortField];
                let bValue = b[sortField];
                
                // 处理数字字段
                if (sortField === 'quantity') {
                    aValue = parseInt(aValue);
                    bValue = parseInt(bValue);
                }
                
                if (sortDirection === 'asc') {
                    return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                } else {
                    return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                }
            });
            
            return filteredOrders;
        }

        // 生产记录搜索和排序
        function filterAndSortProductions() {
            const searchTerm = document.getElementById('production-search').value.toLowerCase();
            const sortOption = document.getElementById('production-sort').value;
            
            let filteredProductions = database.productions.filter(production => {
                return production.id.toLowerCase().includes(searchTerm) ||
                       production.orderId.toLowerCase().includes(searchTerm) ||
                       production.product.toLowerCase().includes(searchTerm) ||
                       (production.notes && production.notes.toLowerCase().includes(searchTerm));
            });
            
            // 排序
            const [sortField, sortDirection] = sortOption.split('-');
            filteredProductions.sort((a, b) => {
                let aValue = a[sortField];
                let bValue = b[sortField];
                
                // 处理数字字段
                if (sortField === 'quantity') {
                    aValue = parseInt(aValue);
                    bValue = parseInt(bValue);
                }
                
                if (sortDirection === 'asc') {
                    return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                } else {
                    return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                }
            });
            
            return filteredProductions;
        }

        // 入库记录搜索和排序
        function filterAndSortStorages() {
            const searchTerm = document.getElementById('storage-search').value.toLowerCase();
            const sortOption = document.getElementById('storage-sort').value;
            
            let filteredStorages = database.storages.filter(storage => {
                return storage.id.toLowerCase().includes(searchTerm) ||
                       storage.productionId.toLowerCase().includes(searchTerm) ||
                       storage.product.toLowerCase().includes(searchTerm) ||
                       (storage.notes && storage.notes.toLowerCase().includes(searchTerm));
            });
            
            // 排序
            const [sortField, sortDirection] = sortOption.split('-');
            filteredStorages.sort((a, b) => {
                let aValue = a[sortField];
                let bValue = b[sortField];
                
                // 处理数字字段
                if (sortField === 'quantity') {
                    aValue = parseInt(aValue);
                    bValue = parseInt(bValue);
                }
                
                if (sortDirection === 'asc') {
                    return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                } else {
                    return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                }
            });
            
            return filteredStorages;
        }

        // 出库记录搜索和排序
        function filterAndSortShipments() {
            const searchTerm = document.getElementById('shipment-search').value.toLowerCase();
            const sortOption = document.getElementById('shipment-sort').value;
            
            let filteredShipments = database.shipments.filter(shipment => {
                return shipment.id.toLowerCase().includes(searchTerm) ||
                       shipment.storageId.toLowerCase().includes(searchTerm) ||
                       shipment.product.toLowerCase().includes(searchTerm) ||
                       (shipment.notes && shipment.notes.toLowerCase().includes(searchTerm));
            });
            
            // 排序
            const [sortField, sortDirection] = sortOption.split('-');
            filteredShipments.sort((a, b) => {
                let aValue = a[sortField];
                let bValue = b[sortField];
                
                // 处理数字字段
                if (sortField === 'quantity') {
                    aValue = parseInt(aValue);
                    bValue = parseInt(bValue);
                }
                
                if (sortDirection === 'asc') {
                    return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                } else {
                    return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                }
            });
            
            return filteredShipments;
        }

        // 重置搜索
        function resetOrderSearch() {
            document.getElementById('order-search').value = '';
            document.getElementById('order-sort').value = 'id-asc';
            updateOrderTable();
        }

        function resetProductionSearch() {
            document.getElementById('production-search').value = '';
            document.getElementById('production-sort').value = 'id-asc';
            updateProductionTable();
        }

        function resetStorageSearch() {
            document.getElementById('storage-search').value = '';
            document.getElementById('storage-sort').value = 'id-asc';
            updateStorageTable();
        }

        function resetShipmentSearch() {
            document.getElementById('shipment-search').value = '';
            document.getElementById('shipment-sort').value = 'id-asc';
            updateShipmentTable();
        }

        // 更新订单表格
        function updateOrderTable() {
            const tbody = document.getElementById('order-table-body');
            tbody.innerHTML = '';
            
            const filteredOrders = filterAndSortOrders();
            
            let totalOrderQuantity = 0;
            let totalProducedQuantity = 0;
            let totalRemainingQuantity = 0;
            
            filteredOrders.forEach(order => {
                // 计算已生产数量和未生产数量
                const relatedProductions = database.productions.filter(p => p.orderId === order.id && p.product === order.product);
                const producedQuantity = relatedProductions.reduce((sum, p) => sum + parseInt(p.quantity), 0);
                const remainingQuantity = parseInt(order.quantity) - producedQuantity;
                
                totalOrderQuantity += parseInt(order.quantity);
                totalProducedQuantity += producedQuantity;
                totalRemainingQuantity += remainingQuantity;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.product}</td>
                    <td>${order.quantity}</td>
                    <td>${producedQuantity}</td>
                    <td class="${remainingQuantity > 0 ? 'warning-text' : ''}">${remainingQuantity}</td>
                    <td>${order.date}</td>
                    <td>${order.customer}</td>
                    <td>${order.notes || ''}</td>
                    <td><span class="badge ${remainingQuantity === 0 ? 'bg-success' : 'bg-warning'}">${remainingQuantity === 0 ? '已完成' : '进行中'}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${hasPermission('edit_data') ? `
                            <button class="btn btn-sm btn-warning" onclick="editOrder('${order.id}')">编辑</button>
                            ` : ''}
                            ${hasPermission('delete_data') ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')">删除</button>
                            ` : ''}
                            ${!hasPermission('edit_data') && !hasPermission('delete_data') ? '<span class="text-muted">无权限</span>' : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 添加总计行
            if (filteredOrders.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-total-row';
                totalRow.innerHTML = `
                    <td colspan="2"><strong>总计</strong></td>
                    <td><strong>${totalOrderQuantity}</strong></td>
                    <td><strong>${totalProducedQuantity}</strong></td>
                    <td><strong>${totalRemainingQuantity}</strong></td>
                    <td colspan="5"></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        // 更新生产表格
        function updateProductionTable() {
            const tbody = document.getElementById('production-table-body');
            tbody.innerHTML = '';
            
            const filteredProductions = filterAndSortProductions();
            
            let totalOrderQuantity = 0;
            let totalProductionQuantity = 0;
            let totalStoredQuantity = 0;
            let totalRemainingQuantity = 0;
            
            filteredProductions.forEach(production => {
                // 计算已入库数量和未入库数量
                const relatedStorages = database.storages.filter(s => s.productionId === production.id && s.product === production.product);
                const storedQuantity = relatedStorages.reduce((sum, s) => {
                    const qty = parseInt(s.quantity) || 0;
                    return sum + qty;
                }, 0);
                const productionQty = parseInt(production.quantity) || 0;
                const remainingQuantity = productionQty - storedQuantity;
                
                // 获取订单信息
                const order = database.orders.find(o => o.id === production.orderId && o.product === production.product);
                const orderQuantity = order ? parseInt(order.quantity) : 0;
                
                totalOrderQuantity += orderQuantity;
                totalProductionQuantity += parseInt(production.quantity);
                totalStoredQuantity += storedQuantity;
                totalRemainingQuantity += remainingQuantity;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${production.id}</td>
                    <td>${production.orderId}</td>
                    <td>${production.product}</td>
                    <td>${orderQuantity}</td>
                    <td>${production.quantity}</td>
                    <td>${storedQuantity}</td>
                    <td class="${remainingQuantity > 0 ? 'warning-text' : ''}">${remainingQuantity}</td>
                    <td>${production.date}</td>
                    <td>${production.manager}</td>
                    <td>${production.notes || ''}</td>
                    <td>
                        <div class="action-buttons">
                            ${hasPermission('edit_data') ? `
                            <button class="btn btn-sm btn-warning" onclick="editProduction('${production.id}')">编辑</button>
                            ` : ''}
                            ${hasPermission('delete_data') ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteProduction('${production.id}')">删除</button>
                            ` : ''}
                            ${!hasPermission('edit_data') && !hasPermission('delete_data') ? '<span class="text-muted">无权限</span>' : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 添加总计行
            if (filteredProductions.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-total-row';
                totalRow.innerHTML = `
                    <td colspan="3"><strong>总计</strong></td>
                    <td><strong>${totalOrderQuantity}</strong></td>
                    <td><strong>${totalProductionQuantity}</strong></td>
                    <td><strong>${totalStoredQuantity}</strong></td>
                    <td><strong>${totalRemainingQuantity}</strong></td>
                    <td colspan="4"></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        // 更新入库表格
        function updateStorageTable() {
            const tbody = document.getElementById('storage-table-body');
            tbody.innerHTML = '';
            
            const filteredStorages = filterAndSortStorages();
            
            let totalProductionQuantity = 0;
            let totalStorageQuantity = 0;
            let totalShippedQuantity = 0;
            let totalRemainingQuantity = 0;
            
            filteredStorages.forEach(storage => {
                // 计算已出库数量和未出库数量
                const relatedShipments = database.shipments.filter(s => s.storageId === storage.id && s.product === storage.product);
                const shippedQuantity = relatedShipments.reduce((sum, s) => {
                    const qty = parseInt(s.quantity) || 0;
                    return sum + qty;
                }, 0);
                const storageQty = parseInt(storage.quantity) || 0;
                const remainingQuantity = storageQty - shippedQuantity;
                
                // 获取生产信息
                const production = database.productions.find(p => p.id === storage.productionId && p.product === storage.product);
                const productionQuantity = production ? parseInt(production.quantity) : 0;
                
                totalProductionQuantity += productionQuantity;
                totalStorageQuantity += parseInt(storage.quantity);
                totalShippedQuantity += shippedQuantity;
                totalRemainingQuantity += remainingQuantity;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${storage.id}</td>
                    <td>${storage.productionId}</td>
                    <td>${storage.orderId}</td>
                    <td>${storage.product}</td>
                    <td>${productionQuantity}</td>
                    <td>${storage.quantity}</td>
                    <td>${shippedQuantity}</td>
                    <td class="${remainingQuantity > 0 ? 'warning-text' : ''}">${remainingQuantity}</td>
                    <td>${storage.date}</td>
                    <td>${storage.manager}</td>
                    <td>${storage.notes || ''}</td>
                    <td>
                        <div class="action-buttons">
                            ${hasPermission('edit_data') ? `
                            <button class="btn btn-sm btn-warning" onclick="editStorage('${storage.id}')">编辑</button>
                            ` : ''}
                            ${hasPermission('delete_data') ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteStorage('${storage.id}')">删除</button>
                            ` : ''}
                            ${!hasPermission('edit_data') && !hasPermission('delete_data') ? '<span class="text-muted">无权限</span>' : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 添加总计行
            if (filteredStorages.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-total-row';
                totalRow.innerHTML = `
                    <td colspan="4"><strong>总计</strong></td>
                    <td><strong>${totalProductionQuantity}</strong></td>
                    <td><strong>${totalStorageQuantity}</strong></td>
                    <td><strong>${totalShippedQuantity}</strong></td>
                    <td><strong>${totalRemainingQuantity}</strong></td>
                    <td colspan="4"></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        // 更新出库表格
        function updateShipmentTable() {
            const tbody = document.getElementById('shipment-table-body');
            tbody.innerHTML = '';
            
            const filteredShipments = filterAndSortShipments();
            
            let totalStorageQuantity = 0;
            let totalShipmentQuantity = 0;
            
            filteredShipments.forEach(shipment => {
                // 获取订单、生产和入库信息
                const order = database.orders.find(o => o.id === shipment.orderId && o.product === shipment.product);
                const production = database.productions.find(p => p.id === shipment.productionId && p.product === shipment.product);
                const storage = database.storages.find(s => s.id === shipment.storageId && s.product === shipment.product);
                
                const orderQuantity = order ? parseInt(order.quantity) : 0;
                const productionQuantity = production ? parseInt(production.quantity) : 0;
                const storageQuantity = storage ? parseInt(storage.quantity) : 0;
                
                totalStorageQuantity += storageQuantity;
                totalShipmentQuantity += parseInt(shipment.quantity);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${shipment.id}</td>
                    <td>${shipment.storageId}</td>
                    <td>${shipment.productionId}</td>
                    <td>${shipment.orderId}</td>
                    <td>${shipment.product}</td>
                    <td>${storageQuantity}</td>
                    <td>${shipment.quantity}</td>
                    <td>${shipment.date}</td>
                    <td>${shipment.customer}</td>
                    <td>${shipment.notes || ''}</td>
                    <td>
                        <div class="action-buttons">
                            ${hasPermission('edit_data') ? `
                            <button class="btn btn-sm btn-warning" onclick="editShipment('${shipment.id}')">编辑</button>
                            ` : ''}
                            ${hasPermission('delete_data') ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteShipment('${shipment.id}')">删除</button>
                            ` : ''}
                            ${!hasPermission('edit_data') && !hasPermission('delete_data') ? '<span class="text-muted">无权限</span>' : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 添加总计行
            if (filteredShipments.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-total-row';
                totalRow.innerHTML = `
                    <td colspan="5"><strong>总计</strong></td>
                    <td><strong>${totalStorageQuantity}</strong></td>
                    <td><strong>${totalShipmentQuantity}</strong></td>
                    <td colspan="4"></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        // 更新库存统计表格
        function updateInventoryTable() {
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';
            
            // 获取所有产品
            const allProducts = [...new Set([
                ...database.orders.map(o => o.product),
                ...database.productions.map(p => p.product),
                ...database.storages.map(s => s.product),
                ...database.shipments.map(s => s.product)
            ])];
            
            let totalOrdered = 0;
            let totalProduced = 0;
            let totalStored = 0;
            let totalShipped = 0;
            let totalOrderedNotProduced = 0;
            let totalProducedNotStored = 0;
            let totalStoredNotShipped = 0;
            let totalCurrentStock = 0;
            
            allProducts.forEach(product => {
                // 计算各种数量
                const productOrdered = database.orders
                    .filter(o => o.product === product)
                    .reduce((sum, o) => sum + parseInt(o.quantity), 0);
                    
                const productProduced = database.productions
                    .filter(p => p.product === product)
                    .reduce((sum, p) => sum + parseInt(p.quantity), 0);
                    
                const productStored = database.storages
                    .filter(s => s.product === product)
                    .reduce((sum, s) => sum + parseInt(s.quantity), 0);
                    
                const productShipped = database.shipments
                    .filter(s => s.product === product)
                    .reduce((sum, s) => sum + parseInt(s.quantity), 0);
                    
                const productOrderedNotProduced = productOrdered - productProduced;
                const productProducedNotStored = productProduced - productStored;
                const productStoredNotShipped = productStored - productShipped;
                const productCurrentStock = productStoredNotShipped;
                
                totalOrdered += productOrdered;
                totalProduced += productProduced;
                totalStored += productStored;
                totalShipped += productShipped;
                totalOrderedNotProduced += productOrderedNotProduced;
                totalProducedNotStored += productProducedNotStored;
                totalStoredNotShipped += productStoredNotShipped;
                totalCurrentStock += productCurrentStock;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product}</td>
                    <td>${productOrdered}</td>
                    <td>${productProduced}</td>
                    <td>${productStored}</td>
                    <td>${productShipped}</td>
                    <td class="${productOrderedNotProduced > 0 ? 'warning-text' : ''}">${productOrderedNotProduced}</td>
                    <td class="${productProducedNotStored > 0 ? 'warning-text' : ''}">${productProducedNotStored}</td>
                    <td class="${productStoredNotShipped > 0 ? 'warning-text' : ''}">${productStoredNotShipped}</td>
                    <td>${productCurrentStock}</td>
                `;
                tbody.appendChild(row);
            });
            
            // 添加总计行
            if (allProducts.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-total-row';
                totalRow.innerHTML = `
                    <td><strong>总计</strong></td>
                    <td><strong>${totalOrdered}</strong></td>
                    <td><strong>${totalProduced}</strong></td>
                    <td><strong>${totalStored}</strong></td>
                    <td><strong>${totalShipped}</strong></td>
                    <td><strong>${totalOrderedNotProduced}</strong></td>
                    <td><strong>${totalProducedNotStored}</strong></td>
                    <td><strong>${totalStoredNotShipped}</strong></td>
                    <td><strong>${totalCurrentStock}</strong></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        // 更新概览卡片
        function updateSummaryCards() {
            // 计算已下单未生产总数
            let totalOrderedNotProduced = 0;
            const orderByProduct = {};
            
            database.orders.forEach(order => {
                const relatedProductions = database.productions.filter(p => p.orderId === order.id && p.product === order.product);
                const producedQuantity = relatedProductions.reduce((sum, p) => sum + parseInt(p.quantity), 0);
                const remainingQuantity = parseInt(order.quantity) - producedQuantity;
                
                totalOrderedNotProduced += Math.max(0, remainingQuantity);
                
                if (!orderByProduct[order.product]) {
                    orderByProduct[order.product] = 0;
                }
                orderByProduct[order.product] += Math.max(0, remainingQuantity);
            });
            
            document.getElementById('total-order').textContent = totalOrderedNotProduced;
            document.getElementById('order-by-product').innerHTML = Object.entries(orderByProduct)
                .map(([product, quantity]) => `${product}: ${quantity}`).join('<br>');
            
            // 计算已生产未入库总数
            let totalProducedNotStored = 0;
            const productionByProduct = {};
            
            database.productions.forEach(production => {
                const relatedStorages = database.storages.filter(s => s.productionId === production.id && s.product === production.product);
                const storedQuantity = relatedStorages.reduce((sum, s) => sum + parseInt(s.quantity), 0);
                const remainingQuantity = parseInt(production.quantity) - storedQuantity;
                
                totalProducedNotStored += Math.max(0, remainingQuantity);
                
                if (!productionByProduct[production.product]) {
                    productionByProduct[production.product] = 0;
                }
                productionByProduct[production.product] += Math.max(0, remainingQuantity);
            });
            
            document.getElementById('total-production').textContent = totalProducedNotStored;
            document.getElementById('production-by-product').innerHTML = Object.entries(productionByProduct)
                .map(([product, quantity]) => `${product}: ${quantity}`).join('<br>');
            
            // 计算已入库未出库总数
            let totalStoredNotShipped = 0;
            const storageByProduct = {};
            
            database.storages.forEach(storage => {
                const relatedShipments = database.shipments.filter(s => s.storageId === storage.id && s.product === storage.product);
                const shippedQuantity = relatedShipments.reduce((sum, s) => sum + parseInt(s.quantity), 0);
                const remainingQuantity = parseInt(storage.quantity) - shippedQuantity;
                
                totalStoredNotShipped += Math.max(0, remainingQuantity);
                
                if (!storageByProduct[storage.product]) {
                    storageByProduct[storage.product] = 0;
                }
                storageByProduct[storage.product] += Math.max(0, remainingQuantity);
            });
            
            document.getElementById('total-storage').textContent = totalStoredNotShipped;
            document.getElementById('storage-by-product').innerHTML = Object.entries(storageByProduct)
                .map(([product, quantity]) => `${product}: ${quantity}`).join('<br>');
            
            // 计算总出库数量
            const totalShipped = database.shipments.reduce((sum, s) => sum + parseInt(s.quantity), 0);
            const shipmentByProduct = {};
            
            database.shipments.forEach(shipment => {
                if (!shipmentByProduct[shipment.product]) {
                    shipmentByProduct[shipment.product] = 0;
                }
                shipmentByProduct[shipment.product] += parseInt(shipment.quantity);
            });
            
            document.getElementById('total-shipment').textContent = totalShipped;
            document.getElementById('shipment-by-product').innerHTML = Object.entries(shipmentByProduct)
                .map(([product, quantity]) => `${product}: ${quantity}`).join('<br>');
        }

        // 更新库存图表
        function updateInventoryChart() {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            
            // 获取所有产品
            const allProducts = [...new Set([
                ...database.orders.map(o => o.product),
                ...database.productions.map(p => p.product),
                ...database.storages.map(s => s.product),
                ...database.shipments.map(s => s.product)
            ])];
            
            const datasets = [];
            
            allProducts.forEach(product => {
                const totalStored = database.storages
                    .filter(s => s.product === product)
                    .reduce((sum, s) => sum + parseInt(s.quantity), 0);
                    
                const totalShipped = database.shipments
                    .filter(s => s.product === product)
                    .reduce((sum, s) => sum + parseInt(s.quantity), 0);
                    
                const currentStock = totalStored - totalShipped;
                
                datasets.push({
                    label: product,
                    data: [currentStock],
                    backgroundColor: getRandomColor()
                });
            });
            
            // 如果图表已存在，销毁它
            if (window.inventoryChartInstance) {
                window.inventoryChartInstance.destroy();
            }
            
            window.inventoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['当前库存'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 生成随机颜色
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 更新订单选择下拉框
        function updateOrderSelect() {
            const select = document.getElementById('production-order');
            select.innerHTML = '<option value="">请选择订单</option>';
            
            database.orders.forEach(order => {
                const relatedProductions = database.productions.filter(p => p.orderId === order.id && p.product === order.product);
                const producedQuantity = relatedProductions.reduce((sum, p) => sum + parseInt(p.quantity), 0);
                const remainingQuantity = parseInt(order.quantity) - producedQuantity;
                
                if (remainingQuantity > 0) {
                    const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `${order.id} - ${order.product} (剩余: ${remainingQuantity})`;
                    option.setAttribute('data-product', order.product);
                    option.setAttribute('data-remaining', remainingQuantity);
                    select.appendChild(option);
                }
            });
        }

        // 更新生产批次选择下拉框
        function updateProductionSelect() {
            const select = document.getElementById('storage-production');
            select.innerHTML = '<option value="">请选择生产批次</option>';
            
            database.productions.forEach(production => {
                const relatedStorages = database.storages.filter(s => s.productionId === production.id && s.product === production.product);
                const storedQuantity = relatedStorages.reduce((sum, s) => sum + parseInt(s.quantity), 0);
                const remainingQuantity = parseInt(production.quantity) - storedQuantity;
                
                if (remainingQuantity > 0) {
                    const option = document.createElement('option');
                    option.value = production.id;
                    option.textContent = `${production.id} - ${production.product} (剩余: ${remainingQuantity})`;
                    option.setAttribute('data-order', production.orderId);
                    option.setAttribute('data-product', production.product);
                    option.setAttribute('data-remaining', remainingQuantity);
                    select.appendChild(option);
                }
            });
        }

        // 更新入库单选择下拉框
        function updateStorageSelect() {
            const select = document.getElementById('shipment-storage');
            select.innerHTML = '<option value="">请选择入库单号</option>';
            
            database.storages.forEach(storage => {
                const relatedShipments = database.shipments.filter(s => s.storageId === storage.id && s.product === storage.product);
                const shippedQuantity = relatedShipments.reduce((sum, s) => sum + parseInt(s.quantity), 0);
                const remainingQuantity = parseInt(storage.quantity) - shippedQuantity;
                
                if (remainingQuantity > 0) {
                    const option = document.createElement('option');
                    option.value = storage.id;
                    option.textContent = `${storage.id} - ${storage.product} (剩余: ${remainingQuantity})`;
                    option.setAttribute('data-production', storage.productionId);
                    option.setAttribute('data-order', storage.orderId);
                    option.setAttribute('data-product', storage.product);
                    option.setAttribute('data-remaining', remainingQuantity);
                    select.appendChild(option);
                }
            });
        }

        // 生成唯一ID函数
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // 设置当前用户到表单字段
        function setCurrentUserToForms() {
            if (currentUser) {
                // 设置订单表单的客户名称
                document.getElementById('order-customer').value = currentUser.username;
                // 设置生产表单的负责人
                document.getElementById('production-manager').value = currentUser.username;
                // 设置入库表单的负责人
                document.getElementById('storage-manager').value = currentUser.username;
                // 设置出库表单的客户名称
                document.getElementById('shipment-customer').value = currentUser.username;
            }
        }

        // 设置日期字段为今天
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('order-date').value = today;
            document.getElementById('production-date').value = today;
            document.getElementById('storage-date').value = today;
            document.getElementById('shipment-date').value = today;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setTodayDate(); // 设置日期为今天

            // 添加调试按钮（仅开发时使用）
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const debugDiv = document.createElement('div');
                debugDiv.style.position = 'fixed';
                debugDiv.style.top = '10px';
                debugDiv.style.right = '10px';
                debugDiv.style.zIndex = '10000';
                debugDiv.innerHTML = `
                    <button onclick="testConnection()" class="btn btn-sm btn-info">测试连接</button>
                    <button onclick="clearLocalData()" class="btn btn-sm btn-warning">清除本地数据</button>
                `;
                document.body.appendChild(debugDiv);
            }

            // 订单搜索和排序事件监听
            document.getElementById('order-search')?.addEventListener('input', updateOrderTable);
            document.getElementById('order-sort')?.addEventListener('change', updateOrderTable);
            
            // 生产记录搜索和排序事件监听
            document.getElementById('production-search')?.addEventListener('input', updateProductionTable);
            document.getElementById('production-sort')?.addEventListener('change', updateProductionTable);
            
            // 入库记录搜索和排序事件监听
            document.getElementById('storage-search')?.addEventListener('input', updateStorageTable);
            document.getElementById('storage-sort')?.addEventListener('change', updateStorageTable);
            
            // 出库记录搜索和排序事件监听
            document.getElementById('shipment-search')?.addEventListener('input', updateShipmentTable);
            document.getElementById('shipment-sort')?.addEventListener('change', updateShipmentTable);

            // 订单选择变化事件
            document.getElementById('production-order')?.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('production-product').value = selectedOption.getAttribute('data-product');
                    const remaining = parseInt(selectedOption.getAttribute('data-remaining'));
                    document.getElementById('production-quantity').max = remaining;
                    document.getElementById('production-quantity-help').textContent = `最大可生产数量: ${remaining}`;
                } else {
                    document.getElementById('production-product').value = '';
                    document.getElementById('production-quantity').max = '';
                    document.getElementById('production-quantity-help').textContent = '最大可生产数量: 0';
                }
            });

            // 生产批次选择变化事件
            document.getElementById('storage-production')?.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('storage-order').value = selectedOption.getAttribute('data-order');
                    document.getElementById('storage-product').value = selectedOption.getAttribute('data-product');
                    const remaining = parseInt(selectedOption.getAttribute('data-remaining'));
                    document.getElementById('storage-quantity').max = remaining;
                    document.getElementById('storage-quantity-help').textContent = `最大可入库数量: ${remaining}`;
                } else {
                    document.getElementById('storage-order').value = '';
                    document.getElementById('storage-product').value = '';
                    document.getElementById('storage-quantity').max = '';
                    document.getElementById('storage-quantity-help').textContent = '最大可入库数量: 0';
                }
            });

            // 入库单选择变化事件
            document.getElementById('shipment-storage')?.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('shipment-production').value = selectedOption.getAttribute('data-production');
                    document.getElementById('shipment-order').value = selectedOption.getAttribute('data-order');
                    document.getElementById('shipment-product').value = selectedOption.getAttribute('data-product');
                    const remaining = parseInt(selectedOption.getAttribute('data-remaining'));
                    document.getElementById('shipment-quantity').max = remaining;
                    document.getElementById('shipment-quantity-help').textContent = `最大可出库数量: ${remaining}`;
                } else {
                    document.getElementById('shipment-production').value = '';
                    document.getElementById('shipment-order').value = '';
                    document.getElementById('shipment-product').value = '';
                    document.getElementById('shipment-quantity').max = '';
                    document.getElementById('shipment-quantity-help').textContent = '最大可出库数量: 0';
                }
            });

            // 模态框显示时设置当前用户和日期
            document.getElementById('addOrderModal')?.addEventListener('show.bs.modal', function() {
                setCurrentUserToForms();
                document.getElementById('order-date').value = new Date().toISOString().split('T')[0];
            });

            document.getElementById('addProductionModal')?.addEventListener('show.bs.modal', function() {
                setCurrentUserToForms();
                document.getElementById('production-date').value = new Date().toISOString().split('T')[0];
            });

            document.getElementById('addStorageModal')?.addEventListener('show.bs.modal', function() {
                setCurrentUserToForms();
                document.getElementById('storage-date').value = new Date().toISOString().split('T')[0];
            });

            document.getElementById('addShipmentModal')?.addEventListener('show.bs.modal', function() {
                setCurrentUserToForms();
                document.getElementById('shipment-date').value = new Date().toISOString().split('T')[0];
            });
        });

        // 保存订单
        document.getElementById('save-order')?.addEventListener('click', function() {
            if (!hasPermission('order_manage')) {
                alert('您没有权限添加订单！');
                return;
            }
            
            let orderId = document.getElementById('order-id').value;
            const product = document.getElementById('order-product').value;
            const quantity = document.getElementById('order-quantity').value;
            const date = document.getElementById('order-date').value;
            const customer = document.getElementById('order-customer').value;
            const notes = document.getElementById('order-notes').value;
            
            if (product && quantity && date && customer) {
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                if (!orderId) {
                    orderId = generateId();
                }
                
                const existingOrder = database.orders.find(order => order.id === orderId);
                if (existingOrder) {
                    alert('订单编号已存在，请使用其他编号');
                    return;
                }
                
                database.orders.push({
                    id: orderId,
                    product,
                    quantity: quantityNum,
                    date,
                    customer,
                    notes
                });
                
                saveData();
                document.getElementById('order-form').reset();
                document.getElementById('order-date').value = new Date().toISOString().split('T')[0];
                setCurrentUserToForms(); // 重置时重新设置当前用户
                bootstrap.Modal.getInstance(document.getElementById('addOrderModal')).hide();
            } else {
                alert('请填写所有必填字段');
            }
        });

        // 保存生产记录
        document.getElementById('save-production')?.addEventListener('click', function() {
            if (!hasPermission('production_manage')) {
                alert('您没有权限添加生产记录！');
                return;
            }
            
            let productionId = document.getElementById('production-id').value;
            const orderId = document.getElementById('production-order').value;
            const product = document.getElementById('production-product').value;
            const quantity = document.getElementById('production-quantity').value;
            const date = document.getElementById('production-date').value;
            const manager = document.getElementById('production-manager').value;
            const notes = document.getElementById('production-notes').value;
            
            if (orderId && product && quantity && date && manager) {
                if (!productionId) {
                    productionId = generateId();
                }
                
                // 修改：只检查同一订单下是否有重复的生产批次
                const existingProduction = database.productions.find(production => 
                    production.id === productionId && production.orderId === orderId && production.product === product
                );
                if (existingProduction) {
                    alert('该订单下已存在相同的生产批次，请使用其他批次编号');
                    return;
                }
                
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                // 检查生产数量是否超过剩余数量
                const selectedOrder = database.orders.find(order => order.id === orderId && order.product === product);
                const relatedProductions = database.productions.filter(p => p.orderId === orderId && p.product === product);
                const producedQuantity = relatedProductions.reduce((sum, p) => {
                    const qty = parseInt(p.quantity) || 0;
                    return sum + qty;
                }, 0);
                const orderQty = parseInt(selectedOrder.quantity) || 0;
                const remainingQuantity = orderQty - producedQuantity;
                
                if (quantityNum > remainingQuantity) {
                    alert(`生产数量不能超过剩余数量 ${remainingQuantity}`);
                    return;
                }
                
                database.productions.push({
                    id: productionId,
                    orderId,
                    product,
                    quantity: quantityNum,
                    date,
                    manager,
                    notes
                });
                
                saveData();
                document.getElementById('production-form').reset();
                document.getElementById('production-date').value = new Date().toISOString().split('T')[0];
                setCurrentUserToForms(); // 重置时重新设置当前用户
                bootstrap.Modal.getInstance(document.getElementById('addProductionModal')).hide();
            } else {
                alert('请填写所有必填字段');
            }
        });

        // 保存入库记录
        document.getElementById('save-storage')?.addEventListener('click', function() {
            if (!hasPermission('storage_manage')) {
                alert('您没有权限添加入库记录！');
                return;
            }
            
            let storageId = document.getElementById('storage-id').value;
            const productionId = document.getElementById('storage-production').value;
            const orderId = document.getElementById('storage-order').value;
            const product = document.getElementById('storage-product').value;
            const quantity = document.getElementById('storage-quantity').value;
            const date = document.getElementById('storage-date').value;
            const manager = document.getElementById('storage-manager').value;
            const notes = document.getElementById('storage-notes').value;
            
            if (productionId && orderId && product && quantity && date && manager) {
                if (!storageId) {
                    storageId = generateId();
                }
                
                const existingStorage = database.storages.find(storage => storage.id === storageId);
                if (existingStorage) {
                    alert('入库单号已存在，请使用其他编号');
                    return;
                }
                
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                // 检查入库数量是否超过剩余数量
                const selectedProduction = database.productions.find(production => production.id === productionId && production.product === product);
                const relatedStorages = database.storages.filter(s => s.productionId === productionId && s.product === product);
                const storedQuantity = relatedStorages.reduce((sum, s) => {
                    const qty = parseInt(s.quantity) || 0;
                    return sum + qty;
                }, 0);
                const productionQty = parseInt(selectedProduction.quantity) || 0;
                const remainingQuantity = productionQty - storedQuantity;
                
                if (quantityNum > remainingQuantity) {
                    alert(`入库数量不能超过剩余数量 ${remainingQuantity}`);
                    return;
                }
                
                database.storages.push({
                    id: storageId,
                    productionId,
                    orderId,
                    product,
                    quantity: quantityNum,
                    date,
                    manager,
                    notes
                });
                
                saveData();
                document.getElementById('storage-form').reset();
                document.getElementById('storage-date').value = new Date().toISOString().split('T')[0];
                setCurrentUserToForms(); // 重置时重新设置当前用户
                bootstrap.Modal.getInstance(document.getElementById('addStorageModal')).hide();
            } else {
                alert('请填写所有必填字段');
            }
        });

        // 保存出库记录
        document.getElementById('save-shipment')?.addEventListener('click', function() {
            if (!hasPermission('shipment_manage')) {
                alert('您没有权限添加出库记录！');
                return;
            }
            
            let shipmentId = document.getElementById('shipment-id').value;
            const storageId = document.getElementById('shipment-storage').value;
            const productionId = document.getElementById('shipment-production').value;
            const orderId = document.getElementById('shipment-order').value;
            const product = document.getElementById('shipment-product').value;
            const quantity = document.getElementById('shipment-quantity').value;
            const date = document.getElementById('shipment-date').value;
            const customer = document.getElementById('shipment-customer').value;
            const notes = document.getElementById('shipment-notes').value;
            
            if (storageId && productionId && orderId && product && quantity && date && customer) {
                if (!shipmentId) {
                    shipmentId = generateId();
                }
                
                const existingShipment = database.shipments.find(shipment => shipment.id === shipmentId);
                if (existingShipment) {
                    alert('出库单号已存在，请使用其他编号');
                    return;
                }
                
                // 验证数量是否为有效数字
                const quantityNum = parseInt(quantity);
                if (isNaN(quantityNum) || quantityNum <= 0) {
                    alert('请输入有效的数量（必须为正整数）！');
                    return;
                }
                
                // 检查出库数量是否超过剩余数量
                const selectedStorage = database.storages.find(storage => storage.id === storageId && storage.product === product);
                const relatedShipments = database.shipments.filter(s => s.storageId === storageId && s.product === product);
                const shippedQuantity = relatedShipments.reduce((sum, s) => {
                    const qty = parseInt(s.quantity) || 0;
                    return sum + qty;
                }, 0);
                const storageQty = parseInt(selectedStorage.quantity) || 0;
                const remainingQuantity = storageQty - shippedQuantity;
                
                if (quantityNum > remainingQuantity) {
                    alert(`出库数量不能超过剩余数量 ${remainingQuantity}`);
                    return;
                }
                
                database.shipments.push({
                    id: shipmentId,
                    storageId,
                    productionId,
                    orderId,
                    product,
                    quantity: quantityNum,
                    date,
                    customer,
                    notes
                });
                
                saveData();
                document.getElementById('shipment-form').reset();
                document.getElementById('shipment-date').value = new Date().toISOString().split('T')[0];
                setCurrentUserToForms(); // 重置时重新设置当前用户
                bootstrap.Modal.getInstance(document.getElementById('addShipmentModal')).hide();
            } else {
                alert('请填写所有必填字段');
            }
        });
    </script>
</body>
</html>